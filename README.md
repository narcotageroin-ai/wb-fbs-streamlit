# Wildberries FBS: тестовое приложение (Streamlit)

Демо‑интерфейс, автоматизирующий базовые операции FBS «под oShip»: загрузка заказов, формирование поставки,
печать стикеров, добавление маркировки (Честный знак / IMEI / GTIN / UIN / срок годности), создание пропусков.

## Что умеет
- **Новые заказы / поиск за период** (`/api/v3/orders/new`, `/api/v3/orders`)
- **Поставка**: создание, добавление заказов (перевод в `confirm`), короба (TRBX), передача в доставку (`complete`),
  получение **QR поставки** и **стикеров коробов**
- **Стикеры заказов** в `png/svg/zplv/zplh` (размер 58×40 или 40×30) — только для статуса `confirm`
- **Метаданные**: SGTIN (Честный знак), UIN, IMEI, GTIN, срок годности (с 21.07.2025)
- **Пропуска**: офисы, список, создание

## Установка локально
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env  # и заполните WB_API_TOKEN, WB_ENV
streamlit run streamlit_app.py
```

## Токен и окружение
- Нужен токен категории **Marketplace**. Для песочницы включите **Test Scope**.
- WB использует единый хост `https://marketplace-api.wildberries.ru`, песочница определяется токеном.
- Лимиты: ~300 rpm на методы FBS заказов/поставок/пропусков (см. оф. доки).

## Важные нюансы
- С 01.09.2025 WB вернет `409`, если `officeID` заказа не совпадает с `destinationOfficeId` у поставки.
  В демо предусмотрено поле `destinationOfficeId` при создании поставки — укажите правильный офис.
- Стикеры заказов доступны только в `confirm`. Добавление заказа в поставку переводит его в `confirm`.
- Короба (TRBX) применимы для поставок на ПВЗ.
- Для маркируемой продукции добавляйте SGTIN/иные метаданные **до передачи поставки в доставку**.

## Архитектура
- `wb_api.py` — тонкий клиент к WB API (requests)
- `streamlit_app.py` — UI с вкладками: Заказы / Поставка / Стикеры / Метаданные / Пропуска
- Можно расширять: сканер штрих‑кодов, печать на термопринтер (через ZPL), интеграция с WMS/МойСклад.

## Безопасность
- Токен хранится локально в `.env`. Не коммитьте `.env` в GitHub.
- Обрабатывайте ошибки `409` (коллизии статусов/лимиты), `429` (rate limit), `403/401` (доступ).

## Дальнейшее развитие
- Роли операторов/логиста, учет смен/столов.
- Функции, похожие на oShip: потоковая упаковка «скан — найден заказ — добавили в поставку — напечатали стикер».
- Печать ZPL напрямую в сетевой термопринтер.

## Новый режим: Конвейер (сканер)
- Поле для сканера принимает строки: `<orderId>`, `<orderId>|<SGTIN>`, `<orderId>|<IMEI>`, `<orderId>|<UIN>`, `<orderId>|<GTIN>`
- При сканировании: (опционально) записывает метаданные → добавляет заказ в активную поставку → генерирует стикер 58×40 PNG.
- Для реальной печати ZPL используйте `print_zpl.py: send_zpl_to_printer(host, 9100, zpl_bytes)`.
